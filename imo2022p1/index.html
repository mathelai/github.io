<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMO 2022 P1 Simulation</title>
    <link rel="stylesheet" href="../tokens.css">
    <link rel="stylesheet" href="../base.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .problem-statement {
            background: #f8f9fa;
            padding: 30px;
            border-bottom: 3px solid #667eea;
        }

        .problem-statement h2 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .problem-text {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            margin-top: 15px;
        }

        .example {
            background: #e9ecef;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
        }

        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 30px;
        }

        @media (max-width: 968px) {
            .content {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }

        .panel h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .control-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
        }

        input[type="number"], input[type="text"], select {
            width: 100%;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input[type="number"]:focus, input[type="text"]:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-help {
            font-size: 0.85em;
            color: #6c757d;
            margin-top: 5px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: 600;
            margin-right: 10px;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button.secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }

        .coin-display {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 6px;
            min-height: 60px;
            align-items: center;
        }

        .coin {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }

        .coin:hover {
            transform: scale(1.1);
        }

        .coin.A {
            background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%);
            color: #333;
        }

        .coin.B {
            background: linear-gradient(135deg, #cd7f32 0%, #e6994f 100%);
            color: white;
        }

        .coin.highlight {
            border: 3px solid #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
        }

        .history-step {
            background: white;
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }

        .step-number {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
        }

        .stats {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            font-weight: 600;
            color: #495057;
        }

        .stat-value {
            color: #667eea;
            font-weight: bold;
        }

        .success {
            color: #28a745;
        }

        .failure {
            color: #dc3545;
        }

        .pattern-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .pair-box {
            background: white;
            padding: 15px 10px;
            border-radius: 6px;
            text-align: center;
            border: 2px solid #dee2e6;
            transition: all 0.3s;
            cursor: pointer;
        }

        .pair-box:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .pair-box.valid {
            border-color: #28a745;
            background: #d4edda;
        }

        .pair-box.invalid {
            border-color: #dc3545;
            background: #f8d7da;
        }

        .pair-label {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .pair-status {
            font-size: 0.85em;
        }

        .observations {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
        }

        .observations ul {
            padding-left: 20px;
        }

        .observations li {
            margin: 8px 0;
            color: #495057;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .controls-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .animation-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 6px;
        }

        .speed-control {
            flex: 1;
        }

        .highlight-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-style: italic;
        }

        .legend {
            display: flex;
            gap: 20px;
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 6px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-coin {
            width: 30px;
            height: 30px;
            border-radius: 50%;
        }
            /* Motion preferences */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        </style>
</head>
<body>
  <a class="skip-link" href="#main">Skip to content</a>
    <main id="main">
  <div class="container">
        <header>
            <h1>IMO 2022 Problem 1</h1>
            <p>Chain Coin Game</p>
        </header>

        <section aria-labelledby="problem-title">
  <div class="problem-statement">
            <h2 id="problem-title">Problem Statement</h2>
            <div class="problem-text">
                <p>The Bank of Oslo issues two types of coin: <strong>aluminium (A)</strong> and <strong>bronze (B)</strong>.
                Marianne has <em>n</em> aluminium coins and <em>n</em> bronze coins, arranged in a row in some arbitrary initial order.</p>

                <p style="margin-top: 15px;">A <strong>chain</strong> is any subsequence of consecutive coins of the same type.
                Given a fixed positive integer <em>k</em> (where 1 ≤ k ≤ 2n), Marianne repeatedly performs the following operation:</p>

                <ul style="margin: 15px 0 15px 30px;">
                    <li>She identifies the longest chain containing the k-th coin from the left</li>
                    <li>She moves all coins in that chain to the left end of the row</li>
                </ul>

                <div class="example">
                    <strong>Example (n=4, k=4):</strong><br>
                    A A B <u>B</u> B A B A → B B B <u>A</u> A A B A → A A A <u>B</u> B B B A → B B B <u>B</u> A A A A → ...
                </div>

                <p style="margin-top: 15px;"><strong>Question:</strong> Find all pairs (n, k) with 1 ≤ k ≤ 2n such that for
                <em>every</em> initial ordering, at some moment during the process, the leftmost n coins will all be of the same type.</p>
            </div>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-coin A"></div>
                    <span>Aluminium (A)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-coin B"></div>
                    <span>Bronze (B)</span>
                </div>
            </div>
        </div>

        <div class="content">
            <div class="panel">
                <h2>Simulation Controls</h2>

                <div class="control-group">
                    <label for="n-input">Number of coins of each type (n):</label>
                    <input type="number" id="n-input" min="1" max="8" value="4">
                    <div class="input-help">Choose between 1 and 8</div>
                </div>

                <div class="control-group">
                    <label for="k-input">Position to track (k):</label>
                    <input type="number" id="k-input" min="1" max="16" value="4">
                    <div class="input-help">Must be between 1 and 2n</div>
                </div>

                <div class="control-group">
                    <label for="coins-input">Initial coin sequence:</label>
                    <input type="text" id="coins-input" value="AABABBBA" placeholder="e.g., AABABBBA">
                    <div class="input-help">Enter sequence using A and B (must have n of each)</div>
                </div>

                <div class="controls-row">
                    <button onclick="generateRandomSequence()">Random Sequence</button>
                    <button onclick="runSimulation()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">Run Simulation</button>
                    <button onclick="resetSimulation()" class="secondary">Reset</button>
                </div>

                <div class="animation-controls">
                    <button onclick="stepForward()" class="secondary">Step Forward</button>
                    <button onclick="toggleAnimation()" id="animate-btn">Animate</button>
                    <div class="speed-control">
                        <label for="speed-slider">Speed:</label>
                        <input type="range" id="speed-slider" min="100" max="2000" value="1000" style="width: 100%;">
                    </div>
                </div>

                <div class="stats" role="status" aria-live="polite">
                    <div class="stat-item">
                        <span class="stat-label">Current Step:</span>
                        <span class="stat-value" id="current-step">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Total Iterations:</span>
                        <span class="stat-value" id="total-iterations">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Leftmost n coins same?</span>
                        <span class="stat-value" id="leftmost-same">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Converged:</span>
                        <span class="stat-value" id="converged">-</span>
                    </div>
                </div>
            </div>

            <div class="panel">
                <h2>Current State</h2>
                <div id="current-display">
                    <div class="loading">Configure settings and run simulation</div>
                </div>
            </div>

            <div class="panel full-width">
                <h2>Simulation History</h2>
                <div id="history-display">
                    <div class="loading">History will appear here after running simulation</div>
                </div>
            </div>

            <div class="panel full-width">
                <h2>Pattern Analysis - Ground Truth Data</h2>
                <div id="pattern-display">
                    <div class="loading">Loading ground truth data...</div>
                </div>
            </div>
        </div>
    </div>

    </main>
  <script>
        // Embedded ground truth data (from results.json)
        const groundTruthData = {"example_traces":[{"initial":"AAAABBBB","final":"AAAABBBB","steps":["AAAABBBB"],"iterations":0,"leftmost_n_same":true},{"initial":"AABBBBAA","final":"BBBBAAAA","steps":["AABBBBAA","BBBBAAAA"],"iterations":1,"leftmost_n_same":true},{"initial":"ABBABAAB","final":"AAAABBBB","steps":["ABBABAAB","AABBBAAB","BBBAAAAB","AAAABBBB"],"iterations":3,"leftmost_n_same":true},{"initial":"BAABBAAB","final":"AAAABBBB","steps":["BAABBAAB","BBBAAAAB","AAAABBBB"],"iterations":2,"leftmost_n_same":true},{"initial":"BBAAABAB","final":"AAAABBBB","steps":["BBAAABAB","AAABBBAB","BBBAAAAB","AAAABBBB"],"iterations":3,"leftmost_n_same":true}],"pattern_results":{"valid_pairs":[[1,1],[1,2],[2,2],[2,3],[3,3],[3,4],[3,5],[4,4],[4,5],[4,6],[5,5],[5,6],[5,7],[5,8],[6,6],[6,7],[6,8],[6,9]],"invalid_pairs":[[2,1],[2,4],[3,1],[3,2],[3,6],[4,1],[4,2],[4,3],[4,7],[4,8],[5,1],[5,2],[5,3],[5,4],[5,9],[5,10],[6,1],[6,2],[6,3],[6,4],[6,5],[6,10],[6,11],[6,12]],"patterns":{"observations":["k = n + 1 works for all tested n","For n=1, valid k values appear symmetric around k=1.5","For n=2, valid k values appear symmetric around k=2.5","For n=1, valid k: [1, 2]","For n=2, valid k: [2, 3]","For n=3, valid k: [3, 4, 5]","For n=4, valid k: [4, 5, 6]","For n=5, valid k: [5, 6, 7, 8]","For n=6, valid k: [6, 7, 8, 9]"],"by_n":{"1":[1,2],"2":[2,3],"3":[3,4,5],"4":[4,5,6],"5":[5,6,7,8],"6":[6,7,8,9]},"formulas_tested":{"k = n + 1":true,"k = 1":false,"k = 2n":false}}}};

        // Simulation state
        let currentSimulation = null;
        let currentStep = 0;
        let animationInterval = null;
        let isAnimating = false;

        // Initialize on load
        window.addEventListener('load', function() {
            displayPatternAnalysis();
            updateKInputRange();
        });

        // Update k input range when n changes
        document.getElementById('n-input').addEventListener('input', function() {
            updateKInputRange();
            updateCoinsInput();
        });

        function updateKInputRange() {
            const n = parseInt(document.getElementById('n-input').value) || 1;
            const kInput = document.getElementById('k-input');
            kInput.max = 2 * n;
            if (parseInt(kInput.value) > 2 * n) {
                kInput.value = n + 1;
            }
        }

        function updateCoinsInput() {
            const n = parseInt(document.getElementById('n-input').value) || 1;
            const currentCoins = document.getElementById('coins-input').value;
            const countA = (currentCoins.match(/A/g) || []).length;
            const countB = (currentCoins.match(/B/g) || []).length;

            if (countA !== n || countB !== n) {
                generateRandomSequence();
            }
        }

        function generateRandomSequence() {
            const n = parseInt(document.getElementById('n-input').value) || 1;
            const coins = Array(n).fill('A').concat(Array(n).fill('B'));

            // Fisher-Yates shuffle
            for (let i = coins.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [coins[i], coins[j]] = [coins[j], coins[i]];
            }

            document.getElementById('coins-input').value = coins.join('');
        }

        class CoinGameSimulator {
            constructor(coins, k) {
                this.initialCoins = coins;
                this.coins = coins;
                this.k = k;
                this.n = coins.length / 2;
                this.history = [coins];
                this.maxIterations = 1000;
            }

            getChainAtPosition(pos) {
                const coinType = this.coins[pos];
                let start = pos;
                let end = pos;

                // Extend left
                while (start > 0 && this.coins[start - 1] === coinType) {
                    start--;
                }

                // Extend right
                while (end < this.coins.length - 1 && this.coins[end + 1] === coinType) {
                    end++;
                }

                return { start, end };
            }

            performOperation() {
                const kIndex = this.k - 1;
                const chain = this.getChainAtPosition(kIndex);

                if (chain.start === 0) {
                    return false; // Already at fixed point
                }

                const chainStr = this.coins.substring(chain.start, chain.end + 1);
                const remaining = this.coins.substring(0, chain.start) + this.coins.substring(chain.end + 1);
                this.coins = chainStr + remaining;

                return true;
            }

            run() {
                let iteration = 0;

                while (iteration < this.maxIterations) {
                    const changed = this.performOperation();

                    if (!changed) {
                        break;
                    }

                    this.history.push(this.coins);
                    iteration++;

                    // Check for cycles
                    if (this.history.length > new Set(this.history).size) {
                        break;
                    }
                }

                const leftmostN = this.coins.substring(0, this.n);
                const allSame = new Set(leftmostN).size === 1;

                return {
                    initial: this.initialCoins,
                    final: this.coins,
                    iterations: iteration,
                    history: this.history,
                    leftmostNSame: allSame,
                    leftmostN: leftmostN,
                    n: this.n,
                    k: this.k
                };
            }
        }

        function runSimulation() {
            const coins = document.getElementById('coins-input').value.toUpperCase();
            const k = parseInt(document.getElementById('k-input').value);
            const n = parseInt(document.getElementById('n-input').value);

            // Validate input
            const countA = (coins.match(/A/g) || []).length;
            const countB = (coins.match(/B/g) || []).length;

            if (countA !== n || countB !== n) {
                alert(`Invalid sequence! Must have exactly ${n} A's and ${n} B's.`);
                return;
            }

            if (k < 1 || k > 2 * n) {
                alert(`k must be between 1 and ${2 * n}`);
                return;
            }

            // Stop any ongoing animation
            stopAnimation();

            // Run simulation
            const simulator = new CoinGameSimulator(coins, k);
            currentSimulation = simulator.run();
            currentStep = 0;

            // Update display
            updateDisplay();
            updateHistory();
            updateStats();
        }

        function resetSimulation() {
            stopAnimation();
            currentSimulation = null;
            currentStep = 0;
            document.getElementById('current-display').innerHTML = '<div class="loading">Configure settings and run simulation</div>';
            document.getElementById('history-display').innerHTML = '<div class="loading">History will appear here after running simulation</div>';
            document.getElementById('current-step').textContent = '0';
            document.getElementById('total-iterations').textContent = '-';
            document.getElementById('leftmost-same').textContent = '-';
            document.getElementById('converged').textContent = '-';
        }

        function stepForward() {
            if (!currentSimulation) {
                alert('Please run a simulation first');
                return;
            }

            if (currentStep < currentSimulation.history.length - 1) {
                currentStep++;
                updateDisplay();
                updateStats();
            }
        }

        function toggleAnimation() {
            if (!currentSimulation) {
                alert('Please run a simulation first');
                return;
            }

            if (isAnimating) {
                stopAnimation();
            } else {
                startAnimation();
            }
        }

        function startAnimation() {
            isAnimating = true;
            document.getElementById('animate-btn').textContent = 'Pause';

            const speed = 2100 - parseInt(document.getElementById('speed-slider').value);

            animationInterval = setInterval(() => {
                if (currentStep < currentSimulation.history.length - 1) {
                    currentStep++;
                    updateDisplay();
                    updateStats();
                } else {
                    stopAnimation();
                }
            }, speed);
        }

        function stopAnimation() {
            isAnimating = false;
            document.getElementById('animate-btn').textContent = 'Animate';
            if (animationInterval) {
                clearInterval(animationInterval);
                animationInterval = null;
            }
        }

        function updateDisplay() {
            if (!currentSimulation) return;

            const coins = currentSimulation.history[currentStep];
            const k = currentSimulation.k;
            const n = currentSimulation.n;

            let html = '<div class="coin-display">';
            for (let i = 0; i < coins.length; i++) {
                const highlight = (i === k - 1) ? 'highlight' : '';
                html += `<div class="coin ${coins[i]} ${highlight}">${coins[i]}</div>`;
            }
            html += '</div>';

            // Show leftmost n coins
            const leftmostN = coins.substring(0, n);
            const leftmostSame = new Set(leftmostN).size === 1;

            html += '<div class="highlight-box">';
            html += `<strong>Leftmost ${n} coins:</strong> ${leftmostN}`;
            html += `<br><strong>All same type?</strong> <span class="${leftmostSame ? 'success' : 'failure'}">${leftmostSame ? 'YES' : 'NO'}</span>`;
            html += '</div>';

            document.getElementById('current-display').innerHTML = html;
        }

        function updateHistory() {
            if (!currentSimulation) return;

            let html = '';
            currentSimulation.history.forEach((state, index) => {
                html += `<div class="history-step">`;
                html += `<div class="step-number">Step ${index}:</div>`;
                html += '<div class="coin-display">';
                for (let i = 0; i < state.length; i++) {
                    const highlight = (i === currentSimulation.k - 1) ? 'highlight' : '';
                    html += `<div class="coin ${state[i]} ${highlight}">${state[i]}</div>`;
                }
                html += '</div>';
                html += '</div>';
            });

            document.getElementById('history-display').innerHTML = html;
        }

        function updateStats() {
            if (!currentSimulation) return;

            document.getElementById('current-step').textContent = currentStep;
            document.getElementById('total-iterations').textContent = currentSimulation.iterations;

            const leftmostSame = currentSimulation.leftmostNSame;
            const leftmostElem = document.getElementById('leftmost-same');
            leftmostElem.textContent = leftmostSame ? 'YES' : 'NO';
            leftmostElem.className = `stat-value ${leftmostSame ? 'success' : 'failure'}`;

            const converged = currentStep === currentSimulation.history.length - 1;
            const convergedElem = document.getElementById('converged');
            convergedElem.textContent = converged ? 'YES' : 'NO';
            convergedElem.className = `stat-value ${converged ? 'success' : ''}`;
        }

        function displayPatternAnalysis() {
            const data = groundTruthData;
            let html = '';

            // Display pattern observations
            html += '<div class="observations">';
            html += '<h3>Key Observations:</h3>';
            html += '<ul>';
            data.pattern_results.patterns.observations.forEach(obs => {
                html += `<li>${obs}</li>`;
            });
            html += '</ul>';
            html += '</div>';

            // Display valid/invalid pairs grid
            html += '<h3 style="margin-top: 20px;">All Tested Pairs (n=1 to 6):</h3>';
            html += '<div class="pattern-grid">';

            const allPairs = new Set();
            for (let n = 1; n <= 6; n++) {
                for (let k = 1; k <= 2 * n; k++) {
                    allPairs.add(`${n},${k}`);
                }
            }

            const validSet = new Set(data.pattern_results.valid_pairs.map(p => `${p[0]},${p[1]}`));

            Array.from(allPairs).sort((a, b) => {
                const [n1, k1] = a.split(',').map(Number);
                const [n2, k2] = b.split(',').map(Number);
                return n1 - n2 || k1 - k2;
            }).forEach(pair => {
                const [n, k] = pair.split(',').map(Number);
                const isValid = validSet.has(pair);
                const className = isValid ? 'valid' : 'invalid';
                const status = isValid ? 'Valid' : 'Invalid';

                html += `<div class="pair-box ${className}" onclick="loadPair(${n}, ${k})">`;
                html += `<div class="pair-label">(${n}, ${k})</div>`;
                html += `<div class="pair-status">${status}</div>`;
                html += '</div>';
            });

            html += '</div>';

            // Display example traces
            html += '<h3 style="margin-top: 30px;">Example Traces (n=4, k=4):</h3>';
            data.example_traces.forEach((trace, index) => {
                html += `<div class="history-step">`;
                html += `<div class="step-number">Example ${index + 1}: ${trace.initial} → ${trace.final} (${trace.iterations} iterations)</div>`;
                html += '</div>';
            });

            document.getElementById('pattern-display').innerHTML = html;
        }

        function loadPair(n, k) {
            document.getElementById('n-input').value = n;
            document.getElementById('k-input').value = k;
            updateKInputRange();
            generateRandomSequence();
        }
    </script>
</body>
</html>
